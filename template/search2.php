<?php // <==================================================================================================================
// ==================================================> ------------- <======================================================
// ===============================================> © Copyright barik <=============================> Скрипт: ПОИСК ПО САЙТУ
// ==================================================> ------------- <======================================================
// =========================================================================================================================
require_once('admin/conf.php'); // =======================================================================> Подключение к бае-данных
$db = $conn;
function search ($query){ // =================================================================> Обработка поискового запроса
$text = ''; // ===============================================================================> Переменная для вывода текста
// ============================================================================================>  Проводим фильтрацию данных
$query = trim($query); // ==================================================================>  Обрезаем пробелы и спецсиволы
$query = strip_tags($query); // ==================================================================>  Удаляем HTML и PHP теги
$query = htmlspecialchars($query); // =============================================>  Экранируем специальные символы
if(!empty($query)){ // ====================================================================> Если поисковый запрос не пустой
  if(strlen($query) < 4){ // ================================================================> Если запрос меньше 4 символов
    $text = '<p>короткий поисковый запрос.</p>';} // ==================================================> Сообщение об ошибке
  else if(strlen($query) > 128){ // ===============================================================> Если более 128 символов
    $text = '<p>длинный поисковый запрос.</p>';} // ===================================================> Сообщение об ошибке
  else{ // =================================================================================================> Если всё верно

    $result = $db->query("SELECT * FROM meta WHERE title LIKE '%$query%' OR description LIKE '%$query%' OR keywords LIKE '%$query%'");// =======================================================================> И выполняем его
    $rows = $result->fetchAll();
    $num = count($rows);
    /*$num = mysql_num_rows($result);*/ // =========================================> Определим колличество найденных совпадений
    if($num > 0){ // =================================================================================> Если совпадения есть
      $row = mysqlite_fetch_assoc($result); // =================================================> Получаем ассоциативный массив
      $text .= '<p>По вашему запросу  <strong>'.$query.'</strong>'; // =====> И начинаем формировать строку поисковой выдачи
      $text .= ' найдено '.$num.' совпадений</p>' ; // ===================================> Показываем количество совпадениц
      // ===================================================================================================================
      do { // ==========================================================================> Динамический вывод всех совпадений
        $text .= '<h3>'.$row['title'].'</h3>';
        $text .= '<p>'.nl2br($row['description']).'</p>';}
      while($row = mysqlite_fetch_assoc($result));} // =================================> Делаем это пока у нас есть результаты
    else{ // =============================================================================> Если найти совпадение не удалось
      $text = '<p>По вашему запросу ничего не найдено.</p>';}}} // ====================================> Сообщение о неудаче
  else{ // =========================================================================================> Если запрос был пустой
    $text = '<p>Задан пустой поисковый запрос.</p>';} // ==============================================> Сообщение об ошибке
return $text;} // =======================================================> Возвращаем сформированную строку поисковой выдачи
// =========================================================================================================================
// ==================================================================================================> Сам скрипт обработчик
if(isset($_POST['query'])){ // ===========================================================================> Если есть запрос
  /*$connect = connectDB(); // ==========================================================> Открываем соединение с базой данных*/
  $db = $conn;
  $search_result = search($_POST['query']); // ================================================> Определяем поисковый запрос 
  echo $search_result;} // =========================================================================================> Выводим
  /*closeDB ($connect);} */// ============================================================> Закрываем соединение с  базой данных
// =========================================================================================================================
// =========================================================================================================================
// ==============================================================================================> // Скрипт: ПОИСК ПО САЙТУ
// =========================================================================================================================
// =====================================================================================================================> ?>